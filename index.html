<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Observability Viewer</title>
<link rel="icon" href="https://algonomy.com/wp-content/uploads/2020/11/favicon-75x75.png" sizes="32x32">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="./common.js"></script>
<link rel="stylesheet" href="./style.css">
</head>
<body>

<header>
  <img src="https://algonomy.com/wp-content/uploads/2020/11/Algonomy-Logo-high-resolution.png" alt="Algonomy Logo">
  <h1>Observability Viewer</h1>
</header>

<div class="container">
    <div id="btnsContainer">

        <button id="addClientBtn">ADD CLIENT</button>
        <select id="clientSelect">
            <option value="">Select a Client...</option>
        </select>
        <input type="file" id="fileInput" accept=".csv,.txt,.log">

        <button id="exportBtn" onclick="exportTableToExcel('logs-table', 'obs-viewer.xlsx')">Export .XLSX</button>
    </div>



    <div class="legend">
    <div class="legend-item"><div class="legend-color engage"></div> Engage/DXP</div>
    <div class="legend-item"><div class="legend-color personalize"></div> Engage/Personalize</div>
    <div class="legend-item"><div class="legend-color personalizeClicks"></div> Engage/Personalize Clicks</div>
    <div class="legend-item"><div class="legend-color recs"></div> RecsForPlacements</div>
    <div class="legend-item"><div class="legend-color recsClicks"></div> RecsForPlacements Clicks</div>
    <div class="legend-item"><div class="legend-color find-id"></div> Find</div>
    <div class="legend-item"><div class="legend-color find-click"></div> Find Click</div>
    <div class="legend-item"><div class="legend-color autocomplete"></div> Autocomplete</div>
    <div class="legend-item"><div class="legend-color default-api"></div> Fallback</div>
    </div>

    <div id="tableContainer" class="table-wrapper"></div>
</div>

<!-- Modal -->
<div id="urlModal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <pre id="modalURL"></pre>
    <button id="copyBtn">COPY TO DOC</button>
  </div>
</div>

<script>
/* ====== Configurações ====== */
const apiClasses = {
  "/rrserver/api/engage/experiences": "engage",
  "/rrserver/api/rrPlatform/recsForPlacements": "recs",
  "/rrserver/apiclick": "recsClicks",
  "/rrserver/api/find/v1/track/click/": "find-click",
  "/rrserver/api/find/v1/44c94ad5598c8afd": "find-id",
  "/rrserver/api/find/v1/autocomplete/": "autocomplete",
  "/rrserver/api/personalize": "personalize"
};
const apiPatterns = Object.keys(apiClasses).sort((a,b) => b.length - a.length);
const placementParamRules = {
  "item_page": ["productId"],
  "add_to_cart_page": ["atcid"],
  "cart_page": ["productId", "cv"],
  "search_page": ["searchTerm"],
  "category_page": ["categoryId"],
  "purchase_complete_page": ["o", "productId", "pp", "q"]
};
const placementApis = [
  "/rrserver/api/rrPlatform/recsForPlacements",
  "/rrserver/api/personalize"
];

/* ====== Função de validação centralizada ====== */
function validateParam(key, value, baseUrl = '', selectedClient = null) {
  let status = 'OK';
  let icon = '✔️';
  let message = '';

  // Validações gerais
  if (value === '' && key === 'userId') { status = 'Invalid'; icon = '❌'; message = 'UserID not Defined'; }
  else if (value === 'anonymous' || value === 'undefined') { status = 'Invalid'; icon = '❌'; message = 'Invalid Value'; }

  // Valida cliente
  if (selectedClient) {
    if (key === 'apiKey') {
      if (value === selectedClient.siteAPIkey) { status='OK'; icon='✔️'; }
      else { status='Invalid'; icon='❌'; message='Invalid apiKey'; }
    }
    if (key === 'apiClientKey') {
      const match = selectedClient.clientAPIkeys.find(k => k.clientKey === value);
      if (match) { status='OK'; icon='✔️'; message=`ClientKey: ${match.name}`; }
      else { status='Invalid'; icon='❌'; message='Invalid apiClientKey'; }
    }
  }

  // Valida IP
  if (key === 'ipor') {
    const ipv4Pattern = /^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)){3}$/;
    if (!ipv4Pattern.test(value)) { status='Invalid'; icon='❌'; message='Invalid IP'; }
  }

  // Valida placements
  if (placementApis.some(api => baseUrl.startsWith(api)) && key === 'placements') {
    const placementTypes = Object.keys(placementParamRules);
    const hasValid = placementTypes.some(pt => value.includes(pt));
    if (!hasValid) { status='Invalid'; icon='❌'; message='Invalid placement'; }
  }

  return { status, icon, message };
}

/* ====== Processa CSV ====== */
document.getElementById("fileInput").addEventListener("change", function(e) {
  const file = e.target.files[0]; 
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    document.getElementById("exportBtn").style.display = "inline-block";

    const lines = event.target.result.split(/\r?\n/); 
    const rows = [];

    const apiCounts = Object.fromEntries(Object.values(apiClasses).concat(['recsClicks', 'personalizeClicks','default-api']).map(k=>[k,0]));

    lines.forEach(rawLine => {
      const line = rawLine.trim();
      const pageMatch = line.match(/^\*(.+?)\*$/);
      if (pageMatch) { rows.push({ page: pageMatch[1].trim() }); return; }
      if (!line.includes("/rrserver/")) return;
      if (line.includes("OPTIONS /rrserver/")) return;

      const timestampMatch = line.match(/^(.+? @ \d{2}:\d{2}:\d{2}\.\d{3})/);
      const timestamp = timestampMatch ? timestampMatch[1].replace(/^"+|"+$/g, "") : "";
      const urlMatch = line.match(/(\/rrserver\/.*?)(?=\s+HTTP\/)/);
      if (!urlMatch) return;
      const url = urlMatch[1].trim();

      const [baseRaw, query] = url.split("?");
      const base = (baseRaw || "").trim();
      const params = {};
      if (query) {
        query.split("&").forEach(pair => {
          if (!pair) return;
          const [k, v] = pair.split("=");
          params[k] = v === undefined ? "" : decodeURIComponent(v);
        });
      }
      rows.push({ timestamp, base, url, params });
    });

    if (rows.length === 0) { 
      document.getElementById("tableContainer").innerHTML = "<p>Nenhuma linha válida encontrada.</p>"; 
      return; 
    }

    const allParams = [...new Set(rows.flatMap(r => r.params ? Object.keys(r.params) : []))];
    let html = "<table id='logs-table'>";
    html += "<tbody>";

    const selectedClientName = document.getElementById('clientSelect').value;
    const clients = JSON.parse(localStorage.getItem('clients') || '[]');
    const selectedClient = clients.find(c => c.siteName === selectedClientName);

    rows.forEach(r => {
      if (r.page) { 
        html += `<tr class="page-row"><td colspan="${allParams.length + 2}">${r.page}</td></tr>`;
        html += "<tr class='sub-header'><th>Time</th><th>URL</th>";
        allParams.forEach(p => html += `<th>${p}</th>`); 
        html += "</tr>";
        return; 
      }

      let rowClass = "default-api"; 
      let matchedApi = "";
      const normalizedBase = (r.base || "").trim();
      const normalizedUrl = (r.url || "").trim();

      for (const api in apiClasses) { 
        if (normalizedBase.startsWith(api)) { rowClass = apiClasses[api]; matchedApi = api; break; } 
      }
      if (rowClass === "default-api") { 
        for (const api of apiPatterns) { 
          if (normalizedBase.includes(api) || normalizedUrl.includes(api)) { 
            rowClass = apiClasses[api]; matchedApi = api; break; 
          } 
        } 
      }

      apiCounts[rowClass]++;

      html += `<tr class="${rowClass}" data-api="${matchedApi}">`;
      html += `<td>${r.timestamp}</td>`;
      html += `<td><button class="getRequest" data-url="${r.url}">GET REQUEST</button></td>`;

      allParams.forEach(p => {
        const val = r.params[p] || '';
        const result = validateParam(p, val, matchedApi, selectedClient);
        html += `<td><div title="${result.message || val}">${val} ${result.icon}</div></td>`; 
      });

      html += "</tr>";
    });

    html += "</tbody></table>";
    document.getElementById("tableContainer").innerHTML = html;

    // Atualiza legenda com contadores
    document.querySelectorAll(".legend-item").forEach(item => {
      const colorDiv = item.querySelector(".legend-color");
      if (!colorDiv) return;
      const cls = [...colorDiv.classList].find(c => apiCounts.hasOwnProperty(c));
      if (cls) {
        const count = apiCounts[cls];
        const labelText = item.textContent.replace(/\(\d+\)$/, "").trim();
        item.innerHTML = `<div class="legend-color ${cls}"></div> ${labelText} (${count})`;
      }
    });

    // ====== Modal GET REQUEST ======
    document.querySelectorAll(".getRequest").forEach(btn => {
      btn.addEventListener("click", () => {
        const fullUrl = btn.dataset.url;
        const [base, query] = fullUrl.split("?");
        const modal = document.getElementById("urlModal");
        const modalPre = document.getElementById("modalURL");
        const copyBtn = document.getElementById("copyBtn");

        let tableHtml = `<table class="modal-table" style="border-collapse: collapse; border: 1px solid #000; width: 100%;">
          <thead>
            <tr><th colspan="3" style="border:1px solid #000; padding:4px;">${base}</th></tr>
            <tr><th style="border:1px solid #000; padding:4px;">Parâmetro</th><th style="border:1px solid #000; padding:4px;">Valor</th><th style="border:1px solid #000; padding:4px;">Status</th></tr>
          </thead><tbody>`;

        let copyText = `${base}\nParâmetro | Valor | Status\n`;

        if (query) {
          query.split("&").forEach(pair => {
            if (!pair) return;
            const [k, vRaw] = pair.split("=");
            const v = decodeURIComponent(vRaw || '');
            const result = validateParam(k, v, base, selectedClient);

            const color = result.status === 'OK' ? 'green' : 'red';
            tableHtml += `<tr>
              <td style="border:1px solid #000; padding:4px;">${k}</td>
              <td style="border:1px solid #000; padding:4px;">${v}</td>
              <td style="border:1px solid #000; padding:4px; color:${color}; font-weight:bold">${result.status}</td>
            </tr>`;
            copyText += `${k} | ${v} | ${result.status}\n`;
          });
        }

        tableHtml += `<tr><td>Request</td><td colspan="2">${fullUrl}</td></tr></tbody></table>`;
        copyText += `Request | ${fullUrl} | \n`;

        modalPre.innerHTML = tableHtml;
        modal.style.display = "block";
        copyBtn.dataset.text = copyText;
      });
    });

    // Copiar modal
    document.getElementById("copyBtn").onclick = async () => {
      const modalPre = document.getElementById("modalURL");
      const html = modalPre.innerHTML;
      try {
        await navigator.clipboard.write([
          new ClipboardItem({
            "text/html": new Blob([html], { type: "text/html" }),
            "text/plain": new Blob([modalPre.innerText], { type: "text/plain" })
          })
        ]);
        document.getElementById("copyBtn").style.backgroundColor = "#4CAF50";
        document.getElementById("copyBtn").textContent = "COPIED!";
      } catch (err) { alert("Erro ao copiar tabela!"); }
    };

    document.querySelector(".modal-close").onclick = () => { document.getElementById("urlModal").style.display = "none"; };
    window.onclick = (event) => { if (event.target == document.getElementById("urlModal")) document.getElementById("urlModal").style.display = "none"; };
  };
  reader.readAsText(file);
});
  function exportTableToExcel(tableID, filename = 'tabela.xlsx') {
  const table = document.getElementById(tableID);
  if (!table) {
    console.error("Tabela não encontrada:", tableID);
    return;
  }

  let wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
  XLSX.writeFile(wb, filename);
}


window.addEventListener("scroll", function() {
  const header = document.querySelector("header");
  if (window.scrollY > 50) {
    header.classList.add("shrink");
    const legend = document.querySelector('.legend');
    legend.style.top = "31px";
  } else {
    header.classList.remove("shrink");
  }
});// Função para ler todos os clientes do localStorage
function getClients() {
  return JSON.parse(localStorage.getItem('clients') || '[]');
}
console.log("Clients from localStorage:", getClients());
// Atualiza dropdown com clientes do localStorage
function updateClientDropdown() {
  const select = document.getElementById('clientSelect');
  select.innerHTML = '<option value="">Select a Client...</option>';
  const clients = JSON.parse(localStorage.getItem('clients') || '[]');
  clients.forEach(client => {
    const option = document.createElement('option');
    option.value = client.siteName;
    option.textContent = client.siteName;
    select.appendChild(option);
  });
}

// Botão ADD CLIENT
document.getElementById('addClientBtn').addEventListener('click', () => {
  window.location.href = 'addClient.html';
});

// Inicializa dropdown ao carregar a página
updateClientDropdown();
</script>

<footer>
  <span id="credits"></span>
</footer>
</body>
</html>
